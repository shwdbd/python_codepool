# 2. 用户与权限

## 为了数据安全

根据前辈血的教训，mongodb不建议裸跑。裸跑的定义是无用户访问控制、无网络访问控制的运行，及其容易被整个拖库，造成数据损失或泄露。

所以重要的事情说三遍：

**不能裸跑！不能裸跑！不能裸跑！**

**何谓不裸跑，mongo官方文档上建议至少做三件事：**

1. **使用定制端口，不使用27017默认端口**
2. **开启ip访问控制**
3. **开启安全认证。**

为达到上述目的，必须在启动mongo服务的时候提升安全性。

## mongo服务的启动

一般使用"mongod.exe"工具启动，为便于操作将参数放在配置文件"mongod.cfg"中。

在windows环境中，一般使用服务方式启动

配置文件默认是YAML格式，其中经常配置的项是：

| 项目 | 默认值 | 说明 |
| -- | -- | -- |
| net.port | 27017 | 端口 |
| net.bindIp | 127.0.0.1 | 允许访问的IP地址 |
| security.authorization:  | enabled | 登录验证是否打开 |

## 用户认证模式（登录）

用户认证模式开启后，需要使用用户密码登录的方式。

mongo使用角色模式，有两类角色：跨数据库角色、单数据库角色。

需要使用createUser函数创建用户后，再行登录。

登录一般有三种方式：

- shell
- GUI工具
- Python等程序访问

下面做一个简要的示范

假设有fd_dev数据库，有admin权限的用户fd_dev_admin，其密码是123456

### shell登录

使用如下命令：

```command
mongo --host 127.0.0.1 --port 28000  -u root  -p 123456 
```

### GUI工具

使用连接字符串：

```str
mongodb://fd_dev_admin:123456@127.0.0.1:28000/?authSource=admin&readPreference=primary&appname=MongoDB%20Compass&ssl=false
```

### python登录

```python
import pymongo
import pprint


if __name__ == "__main__":
    # 数据库访问字符串
    user = "fd_dev_admin"
    password = "123456"
    db_host = "127.0.0.1"
    db_port = "28000"
    url = "mongodb://{user}:{pwd}@{host}:{port}/?authSource=admin&ssl=false".format(
        user=user, pwd=password, host=db_host, port=db_port)
    # 建立连接
    myclient = pymongo.MongoClient(url)
    # 访问数据库
    dblist = myclient.list_database_names()
    pprint.pprint(dblist)
    # 输出：['admin', 'fd_dev']
```

## 账号管理

### 新建账号

### 删除账号

### 修改账号角色

### 查询现有账号

## 附录A Shell命令

```script

# 创建用户
# 用户名myUserAdmin，密码abc123
db.createUser(
  {
    user: "myUserAdmin",
    pwd: "abc123",
    roles: [ { role: "userAdminAnyDatabase", db: "admin" }, "readWriteAnyDatabase" ]
  }
)

# 查询所有角色权限(仅用户自定义角色)
db.runCommand({ rolesInfo: 1 })

# 查看已经创建了的用户的情况：
db.system.users.find()

# 登录
db.auth("用户名", "密码")

# 删除用户
db.system.users.remove({user: "haha"})



```

## 附录B FD数据库规定

| 数据库 | 说明 |
| -- | -- |
| fd | 生产库 |
| fd_test | 测试库 |
| fd_dev | 开发库 |

| 用户 | 密码 | 数据库 | 角色 | 说明 |
| -- | -- | -- |-- | -- |
| root | 123456 | admin | dbOwner | Root超级账号 |
| fd_dev_admin | 123456 | fd_dev | dbOwner | 开发库管理员 |
| fd_dev_dl | 123456 | fd_dev | readWrite | 数据下载用户 |
| fd_dev_api | 123456 | fd_dev | read | fdapi访问用户 |

## 附录C 系统角色

| 角色 | 介绍 |
| -- | -- |
| read | 提供读取所有非系统的集合（数据库）|
| readWrite | 提供读写所有非系统的集合（数据库）和读取所有角色的所有权限 |
| dbAdmin | 提供执行管理任务的功能，例如与架构相关的任务，索引编制，收集统计信息。此角色不授予用户和角色、管理权限。|
| dbOwner | 提供对数据库执行任何管理操作的功能。此角色组合了readWrite，dbAdmin和userAdmin角色授予的权限。|
| userAdmin | 提供在当前数据库上创建和修改角色和用户的功能。由于userAdmin角色允许用户向任何用户（包括他们自己）授予任何权限，因此该角色还间接提供对数据库的超级用户访问权限，或者，如果作用于管理数据库，则提供对群集的访问权限。|
| clusterAdmin | 提供最佳的集群管理访问。此角色组合了clusterManager，clusterMonitor和hostManager角色授予的权限。此外，该角色还提供了dropDatabase操作。|
| readAnyDatabase | 仅在admin 数据库中使用，提供所有数据库的读权限。|
| readWriteAnyDatabase | 尽在admin 数据库中使用，提供所有数据库的读写权限|
| userAdminAnyDatabase | 尽在admin 数据库中使用，提供与userAdmin相同的用户管理操作访问权限，允许用户向任何用户（包括他们自己）授予任何权限，因此该角色还间接提供超级用户访问权限。|
| dbAdminAnyDatabase | 仅在admin 数据库中使用，提供与dbAdmin相同的数据库管理操作访问权限，该角色还在整个群集上提供listDatabases操作。|
| root | 尽在admin 数据库中使用，提供超级权限 |
